<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Encuesta de Clima Laboral - COMBUSES</title>

<style>
:root{
  --bg:#f3f6fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --line:#e5e7eb;
  --primary:#2f5ea6;
  --secondary:#4f7fd1;
  --soft:#eef4ff;
  --danger:#dc2626;
  --radius:18px;
  --shadow:0 20px 45px rgba(0,0,0,.10);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(1200px 520px at 10% -10%, rgba(47,94,166,.16), transparent 55%),
    radial-gradient(1000px 520px at 90% 10%, rgba(79,127,209,.14), transparent 60%),
    var(--bg);
  color:var(--text);
}

.container{
  max-width:1200px;
  margin:auto;
  padding:20px 16px 40px;
}

/* HEADER */
.header{
  text-align:center;
  margin-bottom:20px;
  padding:0 10px;
}
.header img{
  height:60px;
  margin-bottom:12px;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.10));
}
.header h1{
  margin:0;
  font-size:24px;
  color:#355f9e;
  line-height:1.3;
}
.header h2{
  margin:6px 0 0;
  font-weight:500;
  font-size:15px;
  color:#6b8fc7;
}

/* CARD */
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px 18px 28px;
}

/* PROGRESS */
.progress{
  height:8px;
  background:#e6ecf5;
  border-radius:999px;
  overflow:hidden;
  margin-bottom:20px;
}
.progress span{
  display:block;
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--primary),var(--secondary));
  transition:.35s ease;
}

/* STEP TITLE ROW */
.toprow{
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:flex-start;
  margin-bottom:16px;
}
.stepchip{
  display:inline-flex;
  gap:8px;
  align-items:center;
  border:1px solid var(--line);
  padding:8px 12px;
  border-radius:999px;
  background:#fbfdff;
  color:var(--muted);
  font-size:12px;
  max-width:100%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#hintChip{
  font-size:11px;
  white-space:normal;
  line-height:1.4;
  max-width:100%;
}

/* SECTION */
.section{display:none}
.section.active{display:block}

.section h3{
  margin:0 0 16px;
  font-size:20px;
  color:#334155;
  border-left:5px solid var(--primary);
  padding-left:12px;
  line-height:1.4;
}

/* NOTICE */
.notice{
  max-width:100%;
  background:#eef4ff;
  border-left:4px solid #2f5ea6;
  padding:12px 14px;
  border-radius:10px;
  font-size:13px;
  color:#334155;
  line-height:1.4;
  box-shadow:0 6px 16px rgba(47,94,166,.08);
  margin-bottom:16px;
}

/* INPUTS */
.input-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:16px;
}
@media(min-width:640px){ 
  .input-grid{
    grid-template-columns: 1fr 1fr;
  }
}

.input-group{margin-bottom:16px}
.input-group label{
  display:block;
  font-weight:650;
  margin-bottom:6px;
  color:#334155;
  font-size:14px;
}
.input-group input,
.input-group textarea,
.input-group select{
  width:100%;
  padding:14px 16px;
  border-radius:14px;
  border:1px solid var(--line);
  font-size:16px;
  outline:none;
  background:#fff;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}
.input-group input:focus,
.input-group textarea:focus,
.input-group select:focus{
  border-color: rgba(47,94,166,.65);
  box-shadow: 0 0 0 3px rgba(47,94,166,.12);
}
textarea{
  min-height:140px;
  font-family: inherit;
}

/* SELECT STYLING */
.select-wrapper{
  position:relative;
}
.select-wrapper::after{
  content:"▼";
  position:absolute;
  right:16px;
  top:50%;
  transform:translateY(-50%);
  color:var(--muted);
  font-size:12px;
  pointer-events:none;
}

/* QUESTIONS */
.q{
  display:flex;
  flex-direction:column;
  gap:16px;
  padding:16px;
  border-radius:14px;
  border:1px dashed var(--line);
  margin-bottom:16px;
  background:#fff;
}
.q.error{
  border-color: var(--danger);
  background: #fff5f5;
}
.q .qtext{
  font-size:15px;
  line-height:1.5;
}
.q .qtext small{
  display:block;
  margin-top:6px;
  color:var(--muted);
  font-size:12px;
}

/* SCALE */
.scale{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:8px;
}
@media(min-width:480px){
  .scale{
    grid-template-columns:repeat(5, 1fr);
  }
}
.scale label{
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 4px;
  text-align:center;
  font-size:12px;
  cursor:pointer;
  background:#fff;
  transition:.15s ease;
  user-select:none;
  line-height:1.3;
  min-height:52px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.scale label:hover{border-color:var(--primary)}
.scale input{display:none}
.scale label.selected{
  background:var(--soft);
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(47,94,166,.12);
}

/* OPTIONAL BLOCK */
.optionalNote{
  margin:-6px 0 14px;
  color:var(--muted);
  font-size:13px;
  line-height:1.4;
}

/* NAV */
.nav{
  display:flex;
  justify-content:space-between;
  margin-top:24px;
  gap:10px;
}
button{
  padding:16px 24px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:700;
  font-size:15px;
  flex:1;
  min-height:52px;
  display:flex;
  align-items:center;
  justify-content:center;
  touch-action: manipulation;
}
.btn-prev{
  background:#eef2f7;
  color:#334155;
}
.btn-next{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;
}
.btn-prev:disabled{opacity:.6; cursor:not-allowed}
.btn-next:disabled{opacity:.7; cursor:not-allowed}

/* MINI STATUS */
.status{
  margin-top:14px;
  font-size:13px;
  color:var(--muted);
  display:none;
  text-align:center;
}
.status.show{display:block}

/* HIDDEN FIELD */
.hidden-field{
  display:none !important;
}

/* MOBILE SPECIFIC */
@media(max-width:480px){
  .container{
    padding:16px 12px 30px;
  }
  .card{
    padding:18px 14px 24px;
    border-radius:16px;
  }
  .header h1{
    font-size:22px;
  }
  .header h2{
    font-size:14px;
  }
  .section h3{
    font-size:18px;
  }
  .q .qtext{
    font-size:14px;
  }
  .input-group input,
  .input-group textarea,
  .input-group select{
    font-size:16px;
    padding:12px 14px;
  }
  button{
    padding:14px 20px;
    font-size:14px;
  }
  .scale label{
    font-size:11px;
    padding:10px 4px;
    min-height:48px;
  }
}

/* ANIMATIONS */
@keyframes fadeIn{
  from{opacity:0; transform:translateY(10px);}
  to{opacity:1; transform:translateY(0);}
}
.section.active{
  animation:fadeIn 0.3s ease;
}

/* SCROLLBAR */
::-webkit-scrollbar{
  width:6px;
}
::-webkit-scrollbar-track{
  background:#f1f1f1;
}
::-webkit-scrollbar-thumb{
  background:#c1c1c1;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTj-tq3BshHFf6bNvxrroJukZptp60Xd79mTA&s" alt="Logo">
    <h1>Encuesta de Clima Laboral</h1>
    <h2>COMBUSES S.A.</h2>
  </div>

  <div class="card">
    <div class="progress"><span id="bar"></span></div>

    <div class="toprow">
      <div class="stepchip" id="stepChip">Sección 1 de 1</div>
      <div class="stepchip" id="hintChip">Escala: Nunca · Casi nunca · A veces · Casi siempre · Siempre</div>
    </div>

    <form id="form" novalidate>
      <div id="sections"></div>

      <div class="nav">
        <button type="button" class="btn-prev" id="prev">Anterior</button>
        <button type="button" class="btn-next" id="next">Siguiente</button>
      </div>

      <div class="status" id="status"></div>
    </form>
  </div>
</div>

<script>
(() => {
  // ✅ WEBHOOK PABBLY
  const WEBHOOK_URL = "https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjcwNTZkMDYzMzA0MzE1MjY1NTUzMzUxMzQi_pc";

  const ORG_NAME = "COMBUSES S.A.";
  const LIKERT = ["Nunca","Casi nunca","A veces","Casi siempre","Siempre"];

  // Lista de cargos disponibles
  const CARGOS = [
    "ADMINISTRATIVO",
    "CONDUCTOR",
    "GESTOR DE MOVILIDAD",
    "GESTOR DE SERVICIO",
    "OPERATIVO"
  ];

  // ✅ SECCIONES + PREGUNTAS (RENÚMERADAS)
  const SECTIONS = [
    { id: "participant", title: "Datos del Participante", type: "participant" },

    {
      id: "trabajo_equipo",
      title: "Trabajo en Equipo",
      questions: [
        "1. Cuento con la colaboración de mis compañeros de área",
        "2. Cuento con la colaboración de las personas de las otras áreas",
        "3. Cuando ingresé en la Compañía me sentí bienvenido",
        "4. Considero que existe un buen ambiente de trabajo"
      ]
    },

    {
      id: "comunicacion",
      title: "Comunicación",
      questions: [
        "5. Cuando ingresé a Combuses recibí suficiente información sobre la compañía",
        "6. Al ingresar a Combuses, recibí suficiente información sobre el área donde trabajo y la función que realizo",
        "7. Los comunicados internos me proporcionan información útil",
        "8. Tengo disponible información sobre la misión, visión y reglamento interno de trabajo",
        "9. La comunicación interna de Combuses es permanente y planificada",
        "10. La comunicación sobre los resultados y novedades de Combuses es clara y transparente"
      ]
    },

    {
      id: "condiciones",
      title: "Condiciones de Trabajo",
      questions: [
        "11. Combuses cumple las normas de Seguridad y Salud en el trabajo",
        "12. Dispongo de los materiales y recursos necesarios para realizar mi trabajo",
        "13. Las condiciones de espacio, ruido, temperatura, iluminación… me permiten desempeñar mi trabajo con normalidad"
      ]
    },

    {
      id: "formacion",
      title: "Formación",
      questions: [
        "14. Recibo formación para actualizar los conocimientos de mi trabajo",
        "15. Los planes de formación de Combuses se adecuan a mis necesidades de desarrollo profesional en la Compañía"
      ]
    },

    {
      id: "liderazgo",
      title: "Liderazgo",
      questions: [
        "16. El líder de área se preocupa por transmitir los valores, misión y objetivos de Combuses",
        "17. El líder de área proporciona periódicamente información sobre mi desempeño",
        "18. El líder de área es claro y específico cuando define mis objetivos de trabajo o los del departamento",
        "19. El líder de área escucha mis opiniones y me hace partícipe de las decisiones",
        "20. El líder de área me felicita cuando realizo bien mi trabajo",
        "21. El líder de área se preocupa por mantener un buen clima en el equipo",
        "22. El líder de área se preocupa por conocer mis necesidades e intereses",
        "23. El líder de área me trata justamente y evita cualquier tipo de favoritismos",
        "24. El líder de área se relaciona adecuadamente con todas las personas del equipo",
        "25. El líder de área respeta las diferencias de cultura, sexo, religión…",
        "26. Puedo tomar decisiones propias sin necesidad de consultar con el líder de área",
        "27. El líder de área es un referente en Combuses",
        "28. El líder de área hace seguimiento de mi Plan de Desarrollo Individual"
      ]
    },

    {
      id: "cliente",
      title: "Orientación al Cliente",
      questions: [
        "29. Estoy dispuesto a realizar un esfuerzo extra para atender de manera satisfactoria a los clientes",
        "30. He hablado a familiares y amigos sobre las ventajas de contratar servicios de Combuses",
        "31. Recibo retroalimentación para que mi servicio se orienten a la satisfacción de las necesidades del cliente"
      ]
    },

    {
      id: "servicios",
      title: "Percepción de los Servicios Centrales",
      questions: [
        "32. Recibo la ayuda que necesito del departamento de Gestión Humana de Combuses",
        "33. Recibo ayuda oportuna del área de contabilidad cuando lo requiero",
        "34. Recibo ayuda oportuna del área de Sistemas cuando lo requiero",
        "35. Recibo ayuda oportuna del área jurídica cuando lo requiero"
      ]
    },

    {
      id: "satisfaccion",
      title: "Satisfacción en el Puesto de Trabajo",
      questions: [
        "36. Tengo claro cuáles son mis tareas y responsabilidades",
        "37. Conozco cómo mi trabajo contribuye a conseguir los resultados de mi área",
        "38. Mi capacidad profesional está de acuerdo a las tareas y responsabilidades asignadas",
        "39. Mi trabajo me ofrece retos y la oportunidad de seguir mejorando",
        "40. Tengo la oportunidad de proponer nuevos proyectos o nuevas formas de realizar el trabajo",
        "41. Mi trabajo es reconocido y valorado",
        "42. Combuses me da/ofrece la oportunidad de trabajar en proyectos o actividades que suponen nuevos retos",
        "43. Tengo la información que necesito para realizar mi trabajo con excelencia"
      ]
    },

    { id: "sociodemo", title: "Datos sociodemográficos (Opcional)", type: "sociodemo" },
    { id: "observaciones", title: "Observaciones Finales", type: "observaciones" }
  ];

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

  const sectionsWrap = $("#sections");
  const statusEl = $("#status");

  function setStatus(msg){
    statusEl.textContent = msg;
    statusEl.classList.add("show");
  }
  function clearStatus(){
    statusEl.textContent = "";
    statusEl.classList.remove("show");
  }

  const renderScale = (name) => {
    return `
      <div class="scale" data-name="${name}">
        ${LIKERT.map((t, i) => `
          <label>
            <input type="radio" name="${name}" value="${i+1}">
            ${t}
          </label>
        `).join("")}
      </div>
    `;
  };

  const esc = (str) => String(str).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));

  let qCounter = 0;

  SECTIONS.forEach((sec, idx) => {
    const sectionEl = document.createElement("section");
    sectionEl.className = "section" + (idx === 0 ? " active" : "");
    sectionEl.dataset.sectionId = sec.id;

    if (sec.type === "participant") {
      sectionEl.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px;margin-bottom:18px;">
          <h3 style="margin:0">Datos del Participante</h3>
          <div class="notice">
            <strong>Información importante:</strong><br>
            Gracias por participar de esta evaluación de <strong>Clima Organizacional</strong>.
            La información suministrada es de carácter <strong>confidencial</strong> y es muy importante realizarla de manera <strong>honesta</strong>.
          </div>
        </div>

        <div class="input-grid">
          <div class="input-group">
            <label>Cargo <span style="color:#dc2626">*</span></label>
            <div class="select-wrapper">
              <select id="cargo" name="cargo" required>
                <option value="">Selecciona tu cargo...</option>
                ${CARGOS.map(cargo => `<option value="${cargo}">${cargo}</option>`).join('')}
              </select>
            </div>
          </div>
          <input type="hidden" id="observaciones_iniciales" name="observaciones_iniciales" value="Observaciones iniciales (campo oculto)" class="hidden-field">
        </div>
      `;
    } else if (sec.type === "sociodemo") {
      sectionEl.innerHTML = `
        <h3>Datos sociodemográficos (Opcional)</h3>
        <div class="optionalNote">Estos datos son opcionales. Puedes dejarlos sin seleccionar.</div>

        <div class="input-grid">
          <div class="input-group">
            <label>Sexo</label>
            <div class="select-wrapper">
              <select name="sexo">
                <option value="">Selecciona…</option>
                <option>Hombre</option>
                <option>Mujer</option>
                <option>Prefiero no contestar</option>
              </select>
            </div>
          </div>

          <div class="input-group">
            <label>Edad</label>
            <div class="select-wrapper">
              <select name="edad">
                <option value="">Selecciona…</option>
                <option>Menor de 25 años</option>
                <option>Entre 25 – 35 años</option>
                <option>Entre 36 – 45 años</option>
                <option>Entre 46 – 55 años</option>
                <option>56 o más</option>
              </select>
            </div>
          </div>

          <div class="input-group">
            <label>Antigüedad en la Compañía</label>
            <div class="select-wrapper">
              <select name="antiguedad">
                <option value="">Selecciona…</option>
                <option>2 años o menos</option>
                <option>De 3 a 5 años</option>
                <option>De 6 a 10 años</option>
                <option>De 11 a 15 años</option>
                <option>Más de 15 años</option>
              </select>
            </div>
          </div>
        </div>
      `;
    } else if (sec.type === "observaciones") {
      sectionEl.innerHTML = `
        <h3>Observaciones Finales</h3>
        <div class="input-group">
          <label>Observaciones, sugerencias o comentarios finales <span style="color:#dc2626">*</span></label>
          <textarea id="observaciones_finales" name="observaciones_finales" required minlength="10"
            placeholder="Este campo es obligatorio y muy importante para la organización. Escribe con sinceridad."></textarea>
        </div>
      `;
    } else {
      sectionEl.innerHTML = `<h3>${esc(sec.title)}</h3>`;
      sec.questions.forEach((qText) => {
        qCounter++;
        const qName = `${sec.id}_q${qCounter}`;

        const qDiv = document.createElement("div");
        qDiv.className = "q";
        qDiv.dataset.question = "1";
        qDiv.dataset.qname = qName;
        qDiv.dataset.qtext = qText;

        qDiv.innerHTML = `
          <div class="qtext">
            ${esc(qText)}
            <small>Obligatorio</small>
          </div>
          ${renderScale(qName)}
        `;
        sectionEl.appendChild(qDiv);
      });
    }

    sectionsWrap.appendChild(sectionEl);
  });

  document.addEventListener("change", (e) => {
    if (e.target && e.target.matches('input[type="radio"]')) {
      const scale = e.target.closest(".scale");
      if (!scale) return;
      $$("label", scale).forEach(l => l.classList.remove("selected"));
      e.target.parentElement.classList.add("selected");

      const q = e.target.closest(".q");
      if (q) q.classList.remove("error");
    }
  });

  const sections = $$(".section");
  let index = 0;

  const bar = $("#bar");
  const prevBtn = $("#prev");
  const nextBtn = $("#next");
  const stepChip = $("#stepChip");

  function updateNav(){
    sections.forEach(s => s.classList.remove("active"));
    sections[index].classList.add("active");
    bar.style.width = (((index+1)/sections.length)*100).toFixed(0) + "%";
    stepChip.textContent = `Sección ${index+1} de ${sections.length}`;
    prevBtn.disabled = index === 0;
    nextBtn.textContent = (index === sections.length-1) ? "FINALIZAR" : "SIGUIENTE";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function validateCurrentSection(){
    const current = sections[index];

    const requiredInputs = $$("input[required], textarea[required], select[required]", current);
    for (const inp of requiredInputs) {
      if (!inp.checkValidity()) {
        inp.focus();
        inp.reportValidity();
        return false;
      }
    }

    const questions = $$("[data-question]", current);
    if (questions.length) {
      let firstMissing = null;
      questions.forEach(q => q.classList.remove("error"));

      for (const q of questions) {
        const name = q.querySelector(".scale")?.dataset.name;
        const checked = name ? document.querySelector(`input[name="${CSS.escape(name)}"]:checked`) : null;
        if (!checked) {
          q.classList.add("error");
          if (!firstMissing) firstMissing = q;
        }
      }

      if (firstMissing) {
        firstMissing.scrollIntoView({behavior:"smooth", block:"center"});
        alert("Debes responder todas las preguntas de esta sección antes de continuar.");
        return false;
      }
    }

    return true;
  }

  function buildPayload(){
    const form = $("#form");

    const respuestas = {};
    const respuestasDetalladas = [];

    const qBlocks = $$(".q[data-question]");
    for (const qb of qBlocks) {
      const name = qb.querySelector(".scale")?.dataset.name;
      const text = qb.dataset.qtext || "";
      const checked = name ? document.querySelector(`input[name="${CSS.escape(name)}"]:checked`) : null;
      const value = checked ? checked.value : "";

      respuestas[name] = value;

      respuestasDetalladas.push({
        id: name,
        pregunta: text,
        valor: value,
        etiqueta: value ? LIKERT[Number(value)-1] : ""
      });
    }

    const payload = {
      fecha_envio: new Date().toISOString(),
      organizacion: ORG_NAME,
      participante: {
        cargo: form.cargo?.value?.trim() || "",
        observaciones_iniciales: form.observaciones_iniciales?.value?.trim() || ""
      },
      sociodemograficos: {
        sexo: form.sexo?.value || "",
        edad: form.edad?.value || "",
        antiguedad: form.antiguedad?.value || ""
      },
      observaciones_finales: form.observaciones_finales?.value?.trim() || "",
      respuestas,
      respuestas_detalladas: respuestasDetalladas
    };

    return payload;
  }

  async function sendToWebhook(payload){
    const res = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error("Webhook respondió con error: " + res.status + " " + txt);
    }
    return res.text().catch(() => "");
  }

  prevBtn.addEventListener("click", () => {
    clearStatus();
    if (index > 0) {
      index--;
      updateNav();
    }
  });

  nextBtn.addEventListener("click", async () => {
    clearStatus();

    const currentId = sections[index].dataset.sectionId;
    const isOptionalSection = (currentId === "sociodemo");
    if (!isOptionalSection) {
      if (!validateCurrentSection()) return;
    }

    if (index < sections.length-1) {
      index++;
      updateNav();
      return;
    }

    if (!validateCurrentSection()) return;

    nextBtn.disabled = true;
    prevBtn.disabled = true;
    setStatus("Enviando información… por favor espera.");

    try{
      const payload = buildPayload();
      await sendToWebhook(payload);

      alert("✅ Encuesta enviada correctamente. ¡Gracias por tu participación!");
      setStatus("✅ Enviado correctamente.");

      document.getElementById("form").reset();

      index = 0;
      updateNav();
    }catch(err){
      console.error(err);
      alert("❌ No se pudo enviar al SERVIDOR. Revisa tu conexión e intenta de nuevo.");
      setStatus("❌ Error al enviar. Intenta nuevamente.");
    }finally{
      nextBtn.disabled = false;
      prevBtn.disabled = false;
    }
  });

  updateNav();
})();
</script>
</body>
</html>


